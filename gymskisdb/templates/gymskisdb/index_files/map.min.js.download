window.wp=window.wp||{},function(o){o.wp=o.wp||{};var i=o.document,r=o.jQuery,n=wp.listifyResults||{};n.MapServices=[],n.MapService=n.Class.extend({$mapWrapper:r(".job_listings-map-wrapper"),canvas:null,firstLoad:!0,activeCanvas:r.Deferred(),listings:[],markers:[],clusterer:null,bounds:null,geocoder:null,infoBubbleTemplate:wp.template("infoBubbleTemplate"),markerTemplate:wp.template("pinTemplate"),initialize:function(e){r.extend(this,e||{});var t=this;this.canvas&&r(o).on("resize",function(){t.reDraw()})},drawMap:function(){"resolved"!==this.activeCanvas.state()&&(this.activeCanvas.resolve(),o.console&&n.settings.scriptDebug&&console.log("Map Service ready..."),1==n.settings.mapService.useClusters&&this.createClusterer(),r(i).trigger("listifyMapServiceLoaded"))},addMarkers:function(){o.console&&n.settings.scriptDebug&&console.log("Adding markers...");var s=this;_.each(this.listings,function(e,t){s.addMarker(e)})},addMarker:function(e){},resetView:function(){},showDefaultView:function(){},fitBounds:function(){},reDraw:function(){this.fitBounds(),this.listings&&0!==this.listings.length||this.showDefaultView()},autoComplete:null,geocode:null,createClusterer:function(){},maybeClusterOverlay:function(e){},getCanvas:function(){},getCenterLat:function(){},getCenterLng:function(){},getNeLat:function(){},getNeLng:function(){},getRadius:function(){var e="mi"===n.mapUnit?3959:6371,t=this.getCenterLat()/57.2958,s=this.getCenterLng()/57.2958,a=this.getNeLat()/57.2958,i=this.getNeLng()/57.2958,s=e*Math.acos(Math.sin(t)*Math.sin(a)+Math.cos(t)*Math.cos(a)*Math.cos(i-s));return s<1?1:s}}),n.MapServices.GoogleMaps=n.MapService.extend({initialize:function(e){n.MapService.prototype.initialize.call(this,e),this.bounds=new google.maps.LatLngBounds,this.geocoder=new google.maps.Geocoder,InfoBubble.prototype.getAnchorHeight_=function(){return 55},this.infoBubble=new InfoBubble({backgroundClassName:"map-marker-info",borderRadius:4,padding:15,borderColor:"#ffffff",shadowStyle:0,minHeight:120,maxHeight:800,minWidth:225,maxWidth:275,hideCloseButton:!0,flat:!0,anchor:RichMarkerPosition.BOTTOM,disableAutoPan:"1"!=n.settings.mapService.autoPan});var t=this;google.maps.event.addDomListener(o,"load",function(){t.drawMap()})},drawMap:function(){i.getElementById("job_listings-map-canvas")&&(this.canvas=new google.maps.Map(i.getElementById("job_listings-map-canvas"),r.extend(n.settings.mapService,{center:new google.maps.LatLng(parseFloat(n.settings.mapService.center[0]),parseFloat(n.settings.mapService.center[1])),zoom:parseFloat(n.settings.mapService.zoom),maxZoom:parseFloat(n.settings.mapService.maxZoom),minZoom:parseFloat(n.settings.mapService.maxZoomOut),scrollwheel:n.settings.mapService.googlemaps.scrollwheel,styles:n.settings.mapService.googlemaps.styles,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM}})),n.MapService.prototype.drawMap.call(this))},addMarkers:function(e){if(this.resetView(),this.listings=e,!this.listings||0===this.listings.length)return this.showDefaultView();n.MapService.prototype.addMarkers.call(this),(this.firstLoad&&n.settings.mapService.autofit||!this.firstLoad)&&this.fitBounds(),this.clusterer&&this.clusterer.addMarkers(this.markers),this.firstLoad=!1},addMarker:function(e){var t,s=this;null!==e.location.lat&&(t=new RichMarker({content:s.markerTemplate(e),flat:!0,draggable:!1,position:new google.maps.LatLng(e.location.lat,e.location.lng),data:e}),this.clusterer||t.setMap(this.canvas),this.bounds.extend(t.getPosition()),this.markers.push(t),google.maps.event.addListener(t,n.settings.mapService.googlemaps.infoBubbleTrigger,function(){s.infoBubble.get("isOpen")&&s.infoBubble.get("anchor")==t||(s.infoBubble.setContent(s.infoBubbleTemplate(e)),s.infoBubble.open(s.canvas,this))}),google.maps.event.addListener(this.canvas,"click",function(){s.infoBubble.close()}))},resetView:function(){_.each(this.markers,function(e){e.setMap(null)}),this.bounds=new google.maps.LatLngBounds,this.markers=[],this.clusterer&&this.clusterer.clearMarkers(),this.infoBubble.close()},showDefaultView:function(){var e=n.controllers.dataService.getDefaultCoordinates();this.canvas.setZoom(parseInt(n.settings.mapService.zoom)),this.canvas.setCenter(new google.maps.LatLng(parseFloat(e.lat),parseFloat(e.lng)))},fitBounds:function(){n.MapService.prototype.fitBounds.call(this),this.canvas.fitBounds(this.bounds)},reDraw:function(){google.maps.event.trigger(this.canvas,"resize"),n.MapService.prototype.reDraw.call(this)},autoComplete:function(e){var t,s=this,a=r("#"+e);0!==a.length&&(t=new google.maps.places.Autocomplete(i.getElementById(e),n.settings.mapService.googlemaps.autoCompleteArgs),this.canvas&&t.bindTo("bounds",this.canvas),a.unbind("change"),a.keypress(function(e){13==e.which&&n.controllers.dataService.update()}),t.addListener("place_changed",function(){var e=t.getPlace();e.geometry?(n.controllers.dataService.isAddressGeocoded=!0,n.controllers.dataService.radiusSearch(e.geometry.location.lat(),e.geometry.location.lng())):(n.controllers.dataService.isAddressGeocoded=!1,s.geocode(e.name))}))},geocode:function(s){this.isAddressGeocoding=!0,this.geocoder.geocode({address:s},function(e,t){t==google.maps.GeocoderStatus.OK?(t=e[0].geometry.location,n.controllers.dataService.prevAddress=s,n.controllers.dataService.isAddressGeocoded=!0,n.controllers.dataService.$address.each(function(){r(this).val(e[0].formatted_address)}),n.controllers.dataService.radiusSearch(t.lat(),t.lng())):n.controllers.dataService.isAddressGeocoded=!1,this.isAddressGeocoding=!1})},createClusterer:function(){this.clusterer=new MarkerClusterer(this.canvas,this.makers,{gridSize:n.settings.mapService.gridSize,maxZoom:n.settings.mapService.maxZoom,ignoreHiddenMarkers:!0,cssClass:"cluster",imagePath:"",width:53,height:53});var t=this;google.maps.event.addListener(this.clusterer,"clusterclick",function(e){t.maybeClusterOverlay(e)})},maybeClusterOverlay:function(e){var t=this,e=e.getMarkers(),s=this.canvas.getZoom();s<n.settings.mapService.maxZoom||(e=_.map(e,function(e){return t.infoBubbleTemplate(e.data)}),r.magnificPopup.open({type:"inline",items:{src:'<div class="cluster-overlay popup"><ul><li>'+e.join("</li><li>")+"</li></ul></div>"},callbacks:{close:function(){t.canvas.setZoom(s-1),t.canvas.setZoom(s)}}}))},getCanvas:function(){return this.canvas},getCenterLat:function(){return this.getCanvas().getBounds().getCenter().lat()},getCenterLng:function(){return this.getCanvas().getBounds().getCenter().lng()},getNeLat:function(){return this.getCanvas().getBounds().getNorthEast().lat()},getNeLng:function(){return this.getCanvas().getBounds().getNorthEast().lng()}}),n.MapServices.Mapbox=n.MapService.extend({initialize:function(e){n.MapService.prototype.initialize.call(this,e),this.bounds=new L.latLngBounds,this.geocoder=new o.GeoSearch.OpenStreetMapProvider,this.drawMap()},drawMap:function(){i.getElementById("job_listings-map-canvas")&&(L.mapbox.accessToken=n.settings.mapService.mapbox.tileUrl,this.canvas=L.mapbox.map("job_listings-map-canvas","mapbox.streets",{maxZoom:parseInt(n.settings.mapService.maxZoom),minZoom:parseInt(n.settings.mapService.maxZoomOut)}).setView([n.settings.mapService.center[0],n.settings.mapService.center[1]],n.settings.mapService.zoom),n.settings.mapService.googlemaps.scrollwheel||this.canvas.scrollWheelZoom.disable(),n.MapService.prototype.drawMap.apply(this))},addMarkers:function(e){if(this.resetView(),this.listings=e,!this.listings||0===this.listings.length)return this.showDefaultView();n.MapService.prototype.addMarkers.call(this),this.canvas.addLayer(this.markers),(this.firstLoad&&n.settings.mapService.autofit||!this.firstLoad)&&this.fitBounds(),this.firstLoad=!1},addMarker:function(e){var t;null!==e.location.lat&&(t=L.divIcon({iconSize:[30,30],iconAnchor:[15,30],className:"",html:this.markerTemplate(e)}),(t=L.marker([e.location.lat,e.location.lng],{icon:t,data:e})).bindPopup(this.infoBubbleTemplate(e),{closeButton:!1,autoPan:"1"==n.settings.mapService.autoPan,offset:[0,-60],maxHeight:800,minWidth:225,maxWidth:275,className:"map-marker-info"}),this.clusterer?this.markers.addLayer(t):(this.markers.push(t),t.addTo(this.canvas)),this.bounds.extend(t.getLatLng()))},resetView:function(){this.bounds=new L.latLngBounds,this.clusterer?this.markers.clearLayers():(_.each(this.markers,function(e){e.remove()}),this.markers=[])},showDefaultView:function(){var e=n.controllers.dataService.getDefaultCoordinates();this.canvas.setZoom(n.settings.mapService.zoom),this.canvas.setView(L.latLng(e.lat,e.lng))},fitBounds:function(){this.bounds.isValid()&&(n.MapService.prototype.fitBounds.call(this),this.canvas.fitBounds(this.bounds))},reDraw:function(){this.canvas.invalidateSize(),n.MapService.prototype.reDraw.call(this)},geocode:function(e){this.isAddressGeocoding=!0,this.geocoder.search({query:e}).then(function(e){1<=e.length?(e=e[0],n.controllers.dataService.prevAddress=e.label,n.controllers.dataService.$address.val(e.label),n.controllers.dataService.isAddressGeocoded=!0,n.controllers.dataService.radiusSearch(e.y,e.x)):n.controllers.dataService.isAddressGeocoded=!1,this.isAddressGeocoding=!1})},createClusterer:function(){this.markers=L.markerClusterGroup({maxClusterRadius:n.settings.mapService.gridSize,showCoverageOnHover:!1,iconCreateFunction:function(e){return L.divIcon({html:'<div class="cluster">'+e.getChildCount()+"</div>",className:""})}});var t=this;this.markers.on("clusterclick",function(e){t.maybeClusterOverlay(e.layer)}),this.clusterer=!0},maybeClusterOverlay:function(e){var t=this,s=e.getAllChildMarkers();e.zoomToBounds(),this.canvas.getZoom()==n.settings.mapService.maxZoom&&(s=_.map(s,function(e){return t.infoBubbleTemplate(e.options.data)}),r.magnificPopup.open({type:"inline",items:{src:'<div class="cluster-overlay popup"><ul><li>'+s.join("</li><li>")+"</li></ul></div>"},callbacks:{close:function(){e.unspiderfy()}}}))},autoComplete:null,getCanvas:function(){return this.canvas},getCenterLat:function(){return this.getCanvas().getBounds().getCenter().lat},getCenterLng:function(){return this.getCanvas().getBounds().getCenter().lng},getNeLat:function(){return this.getCanvas().getBounds().getNorthEast().lat},getNeLng:function(){return this.getCanvas().getBounds().getNorthEast().lng}}),"googlemaps"==n.settings.mapService.service?n.controllers.mapService=new n.MapServices.GoogleMaps:n.controllers.mapService=new n.MapServices.Mapbox,n.controllers.mapService.autoComplete&&n.settings.mapService.googlemaps.autoComplete&&n.controllers.mapService.autoComplete(n.controllers.dataService.autoComplete),1==n.settings.displayMap&&r.when(n.controllers.mapService.activeCanvas,n.controllers.dataService.activeResponse).done(function(){r(i).trigger("listifyActiveResultsMap"),o.console&&n.settings.scriptDebug&&console.log("Data Service and Map Service are ready..."),r(i).on("listifyDataServiceLoaded",function(){n.controllers.mapService.addMarkers(n.controllers.dataService.response.listings)}),r(i).on("listifyMapServiceLoaded",function(){n.controllers.mapService.addMarkers(n.controllers.dataService.response.listings)})}),r(i).ready(function(){function e(){t.hasClass("fixed-map")&&a.css("height",s.outerHeight()-i.outerHeight()-n.outerHeight())}var t=r("body"),s=r(o),a=r(".job_listings-map-wrapper"),i=r(".site-header"),n=r("#wpadminbar");e(),s.on("resize",e)})}(window);